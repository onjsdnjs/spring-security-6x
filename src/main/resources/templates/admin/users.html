<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">
<head th:replace="~{fragments/common-head :: head-elements(pageTitle='관리자 - 사용자 목록')}"></head>
<body class="flex flex-col min-h-screen bg-app-light-gray font-sans text-app-dark-gray">

<div th:insert="~{fragments/header :: header}"></div>
<div id="toast-container" class="fixed top-5 right-5 z-50 w-full max-w-xs sm:max-w-sm"></div>

<div class="flex flex-1">
    <aside th:insert="~{fragments/admin-menu :: menu}" class="hidden md:block"></aside>

    <main class="flex-1 p-6 md:p-10">
        <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <div class="mb-8 text-center sm:text-left">
                <h1 class="text-3xl font-bold text-app-primary">관리자 - 사용자 목록</h1>
                <p class="text-slate-600 mt-1">플랫폼에 등록된 사용자 계정을 관리합니다.</p>
            </div>

            <div class="overflow-x-auto shadow-md rounded-lg">
                <table id="usersTable" class="min-w-full w-full text-sm text-left text-app-dark-gray">
                    <thead class="text-xs text-white uppercase bg-app-secondary">
                    <tr>
                        <th scope="col" class="py-3.5 px-6 font-semibold">ID</th>
                        <th scope="col" class="py-3.5 px-6 font-semibold">회원명</th>
                        <th scope="col" class="py-3.5 px-6 font-semibold">이메일 (아이디)</th>
                        <th scope="col" class="py-3.5 px-6 font-semibold">그룹</th>
                        <th scope="col" class="py-3.5 px-6 font-semibold">역할</th>
                        <th scope="col" class="py-3.5 px-6 font-semibold">권한</th>
                        <th scope="col" class="py-3.5 px-6 font-semibold">MFA 활성화</th>
                        <th scope="col" class="py-3.5 px-6 font-semibold">관리</th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-app-border">
                    <tr id="usersTableLoadingRow">
                        <td colspan="8" class="py-4 px-6 text-center text-slate-400 italic">
                            <div class="flex justify-center items-center space-x-2">
                                <svg class="animate-spin h-5 w-5 text-app-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span>사용자 정보를 불러오는 중입니다...</span>
                            </div>
                        </td>
                    </tr>
                    <tr id="usersTableEmptyRow" style="display: none;">
                        <td colspan="8" class="py-4 px-6 text-center text-slate-500">
                            표시할 사용자가 없습니다.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-6 text-center">
                <button id="loadUsersBtn" class="px-6 py-2.5 bg-app-accent text-white font-medium text-xs leading-tight uppercase rounded shadow-md hover:bg-app-accent-hover hover:shadow-lg focus:bg-app-accent-hover focus:shadow-lg focus:outline-none focus:ring-0 active:bg-blue-800 active:shadow-lg transition duration-150 ease-in-out">
                    사용자 목록 새로고침
                </button>
            </div>
            <div th:if="${message}" class="mt-6 text-center text-success">
                <p th:text="${message}"></p>
            </div>
            <div th:if="${errorMessage}" class="mt-6 text-center text-error">
                <p th:text="${errorMessage}"></p>
            </div>
        </div>
    </main>
</div>

<div th:insert="~{fragments/footer :: footer}" class="mt-auto"></div>

<script th:src="@{/js/token-holder.js}"></script>
<script th:src="@{/js/init-auth.js}"></script>
<script th:src="@{/js/users.js}"></script> <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof initAuth === 'function') {
            initAuth();
        }
        // users.js의 loadUsers 함수를 오버라이드 또는 관리자용으로 분리
        // 여기서는 users.js를 수정하여 /api/users를 호출하고, 데이터를 받아 테이블을 그리는 renderUsers 함수를 관리자용으로 수정합니다.
        const usersTableBody = document.querySelector("#usersTable tbody");
        if (!usersTableBody) return;

        async function loadAdminUsers() { // 관리자용 사용자 로드 함수 (users.js의 loadUsers와 분리)
            const loadingRow = document.getElementById("usersTableLoadingRow");
            const emptyRow = document.getElementById("usersTableEmptyRow");
            loadingRow.style.display = '';
            emptyRow.style.display = 'none';
            usersTableBody.innerHTML = loadingRow.outerHTML; // 로딩 메시지 유지

            try {
                // /api/users API 호출 (이 API는 ADMIN 권한이 있어야 접근 가능하도록 SecurityConfig에 설정됨)
                let response = await fetchWithAuth("/api/users");

                if (response.status === 401 || response.status === 403) {
                    // Access Token 만료 또는 권한 부족
                    const refreshed = await refreshTokensIfNeeded();
                    if (refreshed) {
                        response = await fetchWithAuth("/api/users"); // 토큰 갱신 후 재시도
                    } else {
                        showToast("세션이 만료되었거나 권한이 없습니다. 다시 로그인해주세요.", "error");
                        TokenMemory.accessToken = null;
                        TokenMemory.refreshToken = null;
                        window.location.href = "/loginForm";
                        return;
                    }
                }

                if (response.ok) {
                    const users = await response.json();
                    renderAdminUsers(users); // 관리자용 렌더링 함수
                } else {
                    const errorData = await response.json().catch(() => ({ message: "사용자 목록 로드 실패" }));
                    showToast(`오류: ${errorData.message || response.statusText}`, "error");
                    usersTableBody.innerHTML = '<tr><td colspan="8" class="py-4 px-6 text-center text-slate-500">사용자 목록을 불러오는 데 실패했습니다.</td></tr>';
                }
            } catch (error) {
                console.error("Error loading admin users:", error);
                showToast("사용자 목록을 불러오는 중 오류가 발생했습니다.", "error");
                usersTableBody.innerHTML = '<tr><td colspan="8" class="py-4 px-6 text-center text-slate-500">사용자 목록을 불러오는 데 실패했습니다.</td></tr>';
            } finally {
                loadingRow.style.display = 'none'; // 로딩 완료
            }
        }

        // 관리자용 사용자 렌더링 함수 (CustomUserDto의 새로운 필드 반영)
        function renderAdminUsers(users) {
            usersTableBody.innerHTML = "";
            if (users && users.length > 0) {
                users.forEach(user => {
                    const tr = usersTableBody.insertRow();
                    tr.insertCell().textContent = user.id || 'N/A'; // ID 추가
                    tr.insertCell().textContent = user.name || 'N/A'; // 이름
                    tr.insertCell().textContent = user.username || 'N/A'; // 이메일 (아이디)

                    // 그룹 목록
                    const groupNames = user.selectedGroupIds && user.selectedGroupIds.length > 0
                        ? user.selectedGroupNames.join(', ') || 'N/A' // UserDto에 selectedGroupNames 추가 필요
                        : 'N/A';
                    tr.insertCell().textContent = groupNames;

                    // 역할 목록 (List<String> roles)
                    const roleNames = user.roles && user.roles.length > 0 ? user.roles.join(', ') : 'N/A';
                    tr.insertCell().textContent = roleNames;

                    // 권한 목록 (List<String> permissions)
                    const permissionNames = user.permissions && user.permissions.length > 0 ? user.permissions.join(', ') : 'N/A';
                    tr.insertCell().textContent = permissionNames;

                    // MFA 활성화 여부
                    tr.insertCell().textContent = user.mfaEnabled ? '활성화' : '비활성화';

                    // 관리 버튼 (수정/삭제)
                    const actionsCell = tr.insertCell();
                    actionsCell.innerHTML = `
                        <a href="/admin/users/${user.id}" class="text-app-accent hover:underline mr-3">수정</a>
                        <a href="/admin/users/delete/${user.id}" class="text-error hover:underline" onclick="return confirm('정말로 이 사용자를 삭제하시겠습니까?');">삭제</a>
                    `;
                });
            } else {
                const emptyRowEl = document.getElementById("usersTableEmptyRow");
                emptyRowEl.style.display = ''; // "표시할 사용자가 없습니다." 행 표시
                usersTableBody.innerHTML = emptyRowEl.outerHTML;
            }
        }

        // 초기 로드
        loadAdminUsers();

        // 새로고침 버튼 이벤트 리스너
        const loadUsersBtn = document.getElementById("loadUsersBtn");
        if (loadUsersBtn) {
            loadUsersBtn.addEventListener("click", loadAdminUsers);
        }

        const message = /*[[${message}]]*/ null;
        if (message) {
            showToast(message, 'success');
        }
        const errorMessage = /*[[${errorMessage}]]*/ null;
        if (errorMessage) {
            showToast(errorMessage, 'error');
        }
    });
    /*]]>*/
</script>
</body>
</html>