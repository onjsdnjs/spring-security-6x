<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">
<head th:replace="~{fragments/common-head :: head-elements(pageTitle='2차 인증 수단 선택')}"></head>
<body class="flex flex-col min-h-screen bg-app-light-gray font-sans text-app-dark-gray">

<div th:insert="~{fragments/header :: header}"></div>
<div id="toast-container" class="fixed top-5 right-5 z-50 w-full max-w-xs sm:max-w-sm"></div>

<div class="flex flex-1">
    <aside th:insert="~{fragments/menu :: menu}" class="hidden md:block"></aside>

    <main class="flex-1 p-6 md:p-10 flex items-center justify-center">
        <div class="w-full max-w-lg">
            <!-- MFA 진행 상태 표시기 컨테이너 -->
            <div id="mfaProgressContainer"></div>

            <div class="w-full max-w-md bg-white p-8 sm:p-10 rounded-xl shadow-2xl mx-auto">
                <div class="text-center mb-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-auto text-app-primary" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <h2 class="mt-4 text-3xl font-bold text-app-primary">2차 인증 수단 선택</h2>
                    <p class="mt-2 text-slate-600" th:if="${username}">
                        <strong th:text="${username}" id="mfaUsernameDisplay" class="font-semibold text-app-accent"></strong>님, 추가 인증을 위해 사용할 인증 수단을 선택해주세요.
                    </p>
                    <p class="mt-2 text-slate-600" th:unless="${username}">
                        추가 인증을 위해 사용할 인증 수단을 선택해주세요.
                    </p>
                </div>

                <div th:if="${errorMessage}" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                    <p th:text="${errorMessage}">에러 메시지</p>
                </div>
                <div id="mfaSelectFactorMessage" class="text-sm text-center min-h-[1.25rem] mb-4">
                </div>

                <div id="mfaFactorSelectionForm" class="space-y-4">
                    <button data-factor="OTT" class="mfa-factor-button w-full flex items-center justify-center px-6 py-3.5 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-app-accent hover:bg-app-accent-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-app-accent transition-all duration-150 ease-in-out transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" >
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 9v.906a2.25 2.25 0 0 1-1.183 1.981l-6.478 3.488M2.25 9v.906a2.25 2.25 0 0 0 1.183 1.981l6.478 3.488m8.839 2.51-8.84-4.755a2.25 2.25 0 0 1 0-4.132l8.84-4.755a2.25 2.25 0 0 1 2.25 0v12.032a2.25 2.25 0 0 1-2.25 0Z" />
                        </svg>
                        이메일 OTP 인증
                    </button>
                    <button data-factor="PASSKEY" class="mfa-factor-button w-full flex items-center justify-center px-6 py-3.5 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-app-accent hover:bg-app-accent-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-app-accent transition-all duration-150 ease-in-out transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12zm-1-5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        Passkey 인증 (FIDO2)
                    </button>
                </div>

                <div class="mt-6 text-center">
                    <a th:href="@{/loginForm}" class="text-sm text-slate-600 hover:text-app-accent hover:underline">로그인 취소 (1차 인증부터 다시)</a>
                </div>

                <!-- State Machine 디버그 정보 (개발 환경에서만 표시) -->
                <div id="stateMachineDebug" class="mt-6 p-4 bg-gray-100 rounded-lg text-xs hidden">
                    <h4 class="font-semibold mb-2">State Machine Debug Info</h4>
                    <p>Current State: <span id="debugCurrentState" class="font-mono"></span></p>
                    <p>Allowed Transitions: <span id="debugAllowedTransitions" class="font-mono"></span></p>
                </div>
            </div>
        </div>
    </main>
</div>

<div th:insert="~{fragments/footer :: footer}" class="mt-auto"></div>

<script th:src="@{/js/token-holder.js}"></script>
<script th:src="@{/js/mfa-state-tracker.js}"></script>
<script th:src="@{/js/mfa-progress-indicator.js}"></script>
<script th:src="@{/js/init-auth.js}"></script>
<script th:src="@{/js/mfa-select-factor.js}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const usernameFromModelSelectFactor = /*[[${username}]]*/ null;
    const usernameFromStorageSelectFactor = sessionStorage.getItem("mfaUsername");
    const mfaUsernameDisplay = document.getElementById("mfaUsernameDisplay");

    if (mfaUsernameDisplay) {
        if (usernameFromModelSelectFactor) {
            mfaUsernameDisplay.textContent = usernameFromModelSelectFactor;
        } else if (usernameFromStorageSelectFactor) {
            mfaUsernameDisplay.textContent = usernameFromStorageSelectFactor;
        }
    }

    // State Machine 초기화 및 진행 상태 표시
    document.addEventListener('DOMContentLoaded', () => {
        if (window.mfaProgressIndicator) {
            window.mfaProgressIndicator.init();

            // 현재 상태로 업데이트
            if (window.mfaStateTracker && window.mfaStateTracker.currentState) {
                window.mfaProgressIndicator.update(
                    window.mfaStateTracker.currentState,
                    window.mfaStateTracker.stateMetadata
                );
            }
        }

        // 디버그 모드 활성화 (개발 환경에서만)
        const isDebugMode = localStorage.getItem('mfaDebugMode') === 'true';
        if (isDebugMode && window.mfaStateTracker) {
            const debugContainer = document.getElementById('stateMachineDebug');
            if (debugContainer) {
                debugContainer.classList.remove('hidden');
                document.getElementById('debugCurrentState').textContent = window.mfaStateTracker.currentState || 'N/A';
                document.getElementById('debugAllowedTransitions').textContent =
                    JSON.stringify(window.mfaStateTracker.allowedTransitions || []);
            }
        }
    });

    const urlParamsSelectFactor = new URLSearchParams(window.location.search);
    const errorMsgSelectFactor = urlParamsSelectFactor.get('error');
    const messageDivSelectFactor = document.getElementById("mfaSelectFactorMessage");
    const modelErrorMessageSelectFactor = /*[[${errorMessage}]]*/ null;

    if (messageDivSelectFactor) {
        if (modelErrorMessageSelectFactor) {
            messageDivSelectFactor.innerHTML = `<p class="text-error font-medium">${modelErrorMessageSelectFactor}</p>`;
        } else if (errorMsgSelectFactor) {
            let displayErrorSelectFactor = "오류가 발생했습니다.";
            switch (errorMsgSelectFactor) {
                case 'invalid_ott_request_ui_context':
                    displayErrorSelectFactor = "잘못된 OTT 요청 컨텍스트입니다. 다시 시도해주세요."; break;
                case 'invalid_ott_challenge_context':
                    displayErrorSelectFactor = "잘못된 OTT 코드 입력 컨텍스트입니다. 다시 시도해주세요."; break;
                case 'invalid_passkey_challenge_context':
                    displayErrorSelectFactor = "잘못된 Passkey 인증 요청입니다. 다시 시도해주세요."; break;
                case 'factor_config_error_request_ui':
                case 'factor_config_error_challenge_ui':
                    displayErrorSelectFactor = "인증 수단 설정에 오류가 있습니다. 관리자에게 문의하세요."; break;
                case 'invalid_challenge_page_url':
                    displayErrorSelectFactor = "잘못된 인증 페이지 요청입니다."; break;
                case 'invalid_state_for_mfa_page':
                    displayErrorSelectFactor = "잘못된 상태에서 접근했습니다. 다시 로그인해주세요."; break;
                default:
                    displayErrorSelectFactor = "인증 수단 선택 중 오류가 발생했습니다: " + errorMsgSelectFactor;
            }
            messageDivSelectFactor.innerHTML = `<p class="text-error font-medium">${displayErrorSelectFactor}</p>`;
            if(typeof showToast === 'function') showToast(displayErrorSelectFactor, "error");
        }
    }

    const mfaSessionIdSelectFactor = sessionStorage.getItem("mfaSessionId");
    if (!mfaSessionIdSelectFactor && typeof showToast === 'function') {
        showToast("MFA 세션 정보를 찾을 수 없습니다. 다시 로그인 해주세요.", "error", 3000);
        document.querySelectorAll('.mfa-factor-button').forEach(button => button.disabled = true);
    }

    if (typeof initAuth === 'function') {
        initAuth();
    }
    /*]]>*/
</script>
</body>
</html>